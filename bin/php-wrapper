#!/usr/bin/env bash

source /etc/httpd-bootstrap.conf

NICE=/bin/nice
NICENESS="${PHP_CGI_NICENESS:-15}"
PHP_CGI=/usr/bin/php-cgi

# Used to override the PHP operating mode options
PHP_OPTIONS="${1:-}"

# PHP child process management should always be disabled with mod_fcgid
export PHP_FCGI_CHILDREN=0
export PHP_FCGI_MAX_REQUESTS=15000
export PHPRC=/etc
export REDIRECT_STATUS=200
export TMP="${APACHE_CONTENT_ROOT}/var/tmp"
export TEMP="${TMP}"
export TMPDIR="${TMP}"

# Use numeric values here. 
# To identify the correct value use: php -r "echo E_ALL & ~E_DEPRECATED;"
#   Default Value: E_ALL & ~E_NOTICE        = 30711
#   Development Value: E_ALL | E_STRICT     = 32767
#   Production Value: E_ALL & ~E_DEPRECATED = 22527
PHP_OPTIONS_ERROR_REPORTING=22527
PHP_OPTIONS_DISPLAY_ERRORS="Off"
PHP_OPTIONS_HTML_ERRORS="Off"

PHP_OPTIONS_XDEBUG_SHOW_EXCEPTION_TRACE="Off"
PHP_OPTIONS_XDEBUG_TRACE_ENABLE_TRIGGER="Off"
PHP_OPTIONS_XDEBUG_TRACE_FORMAT="0"
PHP_OPTIONS_XDEBUG_COLLECT_PARAMS="0"
PHP_OPTIONS_XDEBUG_COLLECT_RETURN="Off"
PHP_OPTIONS_XDEBUG_SHOW_MEM_DELTA="Off"
PHP_OPTIONS_XDEBUG_REMOTE_ENABLE="Off"
PHP_OPTIONS_XDEBUG_REMOTE_MODE="req"
PHP_OPTIONS_XDEBUG_REMOTE_CONNECT_BACK="Off"
PHP_OPTIONS_XDEBUG_PROFILER_ENABLE_TRIGGER="Off"

# Mode of operation: production,development,debug.
# Used to enable appropriate php options for requirements
PHP_OPERATING_MODE="${APACHE_OPERATING_MODE:-production}"

# Set operating mode specific options
case "${PHP_OPERATING_MODE}" in
	development|debug)
		PHP_OPTIONS_DISPLAY_ERRORS="On"
		PHP_OPTIONS_ERROR_REPORTING=32767
		PHP_OPTIONS_HTML_ERRORS="On"
		PHP_OPTIONS_XDEBUG_SHOW_EXCEPTION_TRACE="On"
		PHP_OPTIONS_XDEBUG_TRACE_ENABLE_TRIGGER="On"
		PHP_OPTIONS_XDEBUG_TRACE_FORMAT="0"
		PHP_OPTIONS_XDEBUG_COLLECT_PARAMS="4"
		PHP_OPTIONS_XDEBUG_COLLECT_RETURN="On"
		PHP_OPTIONS_XDEBUG_SHOW_MEM_DELTA="On"
		PHP_OPTIONS_XDEBUG_REMOTE_ENABLE="On"
		PHP_OPTIONS_XDEBUG_REMOTE_CONNECT_BACK="On"
		PHP_OPTIONS_XDEBUG_PROFILER_ENABLE_TRIGGER="On"
		case "${PHP_OPERATING_MODE}" in
			debug)
				PHP_OPTIONS_XDEBUG_TRACE_FORMAT="1"
				PHP_OPTIONS_XDEBUG_COLLECT_PARAMS="2"
				;;
		esac
		;;
	production|*)
		;;
esac

PHP_OPERATING_MODE_OPTIONS="
 -d error_reporting=${PHP_OPTIONS_ERROR_REPORTING}
 -d display_errors=${PHP_OPTIONS_DISPLAY_ERRORS}
 -d html_errors=${PHP_OPTIONS_HTML_ERRORS}
 -d xdebug.show_exception_trace=${PHP_OPTIONS_XDEBUG_SHOW_EXCEPTION_TRACE}
 -d xdebug.trace_enable_trigger=${PHP_OPTIONS_XDEBUG_TRACE_ENABLE_TRIGGER}
 -d xdebug.trace_output_dir=${TMP}
 -d xdebug.trace_format=${PHP_OPTIONS_XDEBUG_TRACE_FORMAT}
 -d xdebug.collect_params=${PHP_OPTIONS_XDEBUG_COLLECT_PARAMS}
 -d xdebug.collect_return=${PHP_OPTIONS_XDEBUG_COLLECT_RETURN}
 -d xdebug.show_mem_delta=${PHP_OPTIONS_XDEBUG_SHOW_MEM_DELTA}
 -d xdebug.remote_enable=${PHP_OPTIONS_XDEBUG_REMOTE_ENABLE}
 -d xdebug.remote_mode=${PHP_OPTIONS_XDEBUG_REMOTE_MODE}
 -d xdebug.remote_connect_back=${PHP_OPTIONS_XDEBUG_REMOTE_CONNECT_BACK}
 -d xdebug.profiler_enable_trigger=${PHP_OPTIONS_XDEBUG_PROFILER_ENABLE_TRIGGER}
 -d xdebug.profiler_output_dir=${TMP}
"

# FastCGI-enabled PHP executable
exec ${NICE} \
	-n ${NICENESS} \
	${PHP_CGI} \
	${PHP_OPERATING_MODE_OPTIONS} \
	${PHP_OPTIONS}
